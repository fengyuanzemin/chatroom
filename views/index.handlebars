<style>
html{
padding-bottom: 46px;
}
form { 
    background: #000; 
    padding: .3rem; 
    position: fixed; 
    bottom: 0; 
    left: 0;
    width: 100%; 
}
form input { 
    border: 0; 
    padding: 10px; 
    width: 90%; 
    margin-right: .3rem; 
}
form button { 
    width: 9%; 
    background: rgb(130, 224, 255); 
    border: none; 
    padding: .625rem; 
}
#messages { 
    list-style-type: none; 
    margin: 0; 
    padding: 0; 
}
#messages li { 
    padding: .3125rem .625rem; 
}
#messages li:nth-child(odd) .chat{ 
    background-color: #eee; 
}
#messages li:nth-child(even) .chat{
	background-color: #d4edf4;
}
#messages li:nth-child(odd) .tan{
	 border-right-color: #eee;
}
#messages li:nth-child(even) .tan{
	 border-right-color: #d4edf4;
}
.name{
    font-size: 1.1rem;
    text-align: center;
    white-space: nowrap;
}
li img{
	max-width: 100%;
}
li .avatar{
	display: inline-block;
	width: 4.44rem;
	height: 7.19rem;
}
li .chat{
	width: 18rem;
	display: inline-block;
	height: 3rem;
	position:relative;
	bottom: 3.6rem;
	left: 3rem;
	border-radius: .4rem;
	text-indent: .5rem;
	padding-top: .25rem;
}
.tan{
	display: inline-block;
	position: absolute;
	top: .6rem;
	left: -1.7rem;
	border-top: .7rem solid transparent;
	border-right: 1.8rem solid #fff;
	border-bottom: .2rem solid transparent;
}
.users-in-out{
    text-align: center;
}
.whisper-color{
    background-color: #9e9e9e;
}
</style>


<ul id="messages">
	{{!-- <li>
		<div class="avatar">
			<img src="imgs/1.jpg" alt="头像" />
			<p class="name">李晖梁<p>
		</div>
		<div class="chat">
			<span class="tan"></span>
			<p>我来了</p>
		</div>
	</li> --}}
</ul>
<form>
     <input id="m" autocomplete="off" /><button>发送</button>
</form>
<script src="/js/layer/layer.js"></script>
<script src="//cdn.bootcss.com/socket.io/1.4.6/socket.io.min.js"></script>
	
<script>
    $(function(){
        //prompt层
        layer.prompt({title: '请输入昵称',offset: ['200px', '400px'],skin: 'layui-layer-lan'}, function(value,index){
            layer.close(index);
            var name=value;
            if($.trim(name).length > 0) {
            $('#m').focus();
            // 聊天开始
            var socket = io();
            // 定义一个私聊公聊的变量吧

            socket.emit('user connection', name);
            $('button').click(function(){
                socket.emit('chat message', $('#m').val());
                $('#m').val('');
                // return 去掉的话，页面会刷新
                return false;
            });
            // 头像点击事件 ，直接开始私聊
            $('body').on('click','.avatar',function(){
                var socket_id=$(this).data('id');
                socket.emit('whisper-first',socket_id);
            });
            // 接收到服务器的消息，被请求的客户端有个confirm
            // second是to的窗口
            socket.on('whisper-second',function(msg){
                layer.confirm('有个叫'+msg.user.name+'的人想和你私聊，是否同意？', {skin: 'layui-layer-lan' },function(index){
                    layer.close(index);
                    // 同意，先发送同意消息，然后打开一个聊天的layer
                    socket.emit('whisper-third',{
                        to:msg.to,
                        from:msg.from
                    });
                    layer.open({
                        type: 1,
                        title: msg.user.name,
                        move: false,
                        skin: 'layui-layer-lan', //加上边框
                        shift: 2,
                        content: '',
                    });
                });  
            });
            // forth是from的窗口
            socket.on('whisper-forth',function(msg){

                layer.alert(msg.user.name+'已经同意了你的私聊请求',{
                    time:3000,
                    skin: 'layui-layer-lan',
                });

                // 打开一个私聊窗口，里面只有from和to两个人
                layer.open({
                     type: 1,
                        title: msg.user.name,
                        move: false,
                        skin: 'layui-layer-lan', //加上边框
                        shift: 2,
                        content: '',
                    });
            });
            // // 
            // // 收到不是本人的私聊消息
            // socket.on('whisper-first',function(msg){
            //     console.log(msg);
            //     var a=msg.split('-');
            //     var con=confirm('有个来自外星球的人想和你聊天');
            //     if(con===true){
            //         $('#m').focus();
            //         $('body').css('background-color','#9e9e9e');
            //         socket.broadcast.to(a[2])emit('whisper-second',a[1]);
            //     }else {
            //         return false;
            //     }
            // });
            socket.on('chat message', function(msg){
                $('#messages').append(
                    '<li>'+
                    '<div class="avatar" data-id="'+msg.user.id+'">'+
                    '<img src="imgs/'+msg.user.avatar+'.jpg" alt="头像" />'+
                    '<p class="name">'+msg.user.name+'<p>'+
                    '</div>'+
                    '<div class="chat">'+
                    '<span class="tan"></span>'+
                    '<p>'+msg.msg+'</p>'+
                    '</div>'+
                    '</li>');
                $('html, body, #message').animate({scrollTop: $(document).height()}, 400);
            });
            socket.on('hi', function(msg){
                // console.log(msg);
                $('#messages').append($('<li class="users-in-out">').text(msg));
                $('html, body, #message').animate({scrollTop: $(document).height()}, 400);
            });
        }
        });
        

    });
</script>